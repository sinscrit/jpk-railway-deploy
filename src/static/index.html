<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
    <link rel="apple-touch-icon" sizes="64x64" href="/favicon.png" />
    <title>JPK to JSON Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .accent-orange { color: #F36C21; }
        .bg-accent-orange { background-color: #F36C21; }
        .border-accent-orange { border-color: #F36C21; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-slate-50 text-slate-600 antialiased min-h-screen flex items-center justify-center p-4">

    <!-- Main Application Container -->
    <main class="w-full max-w-2xl bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden">

        <!-- Header -->
        <header class="border-b border-slate-100 p-6 flex items-center justify-between bg-white">
            <!-- Logo -->
            <div class="flex items-center gap-2">
                <div class="relative flex items-center justify-center w-8 h-8 bg-[#F36C21] rounded-lg">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                    </svg>
                </div>
                <span class="text-lg font-semibold tracking-tight text-slate-900">IO Integrated</span>
            </div>

            <!-- Auth Section -->
            <div id="authSection" class="flex items-center gap-3">
                <!-- Login Button (shown when not authenticated) -->
                <div id="loginSection" style="display: none;">
                    <a href="/login" class="bg-[#F36C21] hover:bg-[#e05a10] text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center gap-2">
                        <i data-lucide="log-in" class="w-4 h-4"></i>
                        Login with Google
                    </a>
                </div>
                <!-- User Section (shown when authenticated) -->
                <div id="userSection" style="display: none;" class="flex items-center gap-3">
                    <a href="/admin" id="adminLink" style="display: none;" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors duration-200">
                        Admin
                    </a>
                    <div class="flex items-center gap-2">
                        <div id="userInitials" class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-medium text-xs"></div>
                        <span id="userName" class="text-sm font-medium text-slate-700 hidden sm:block"></span>
                    </div>
                    <a href="/logout" class="bg-rose-50 hover:bg-rose-100 text-rose-600 border border-rose-200 px-4 py-1.5 rounded-lg text-sm font-medium transition-colors duration-200">
                        Logout
                    </a>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div class="p-8 space-y-6">

            <!-- Title -->
            <div class="text-center space-y-1">
                <h1 class="text-3xl font-semibold tracking-tight text-slate-900">JPK to JSON Converter</h1>
                <p class="text-base text-slate-500">Securely transform your audit files for analysis</p>
            </div>

            <!-- Queue Status -->
            <div id="queueStatus" class="bg-slate-50 border border-slate-200 rounded-xl p-6">
                <h3 class="text-center text-sm font-semibold text-slate-900 mb-4 tracking-tight">Queue Status</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 divide-y md:divide-y-0 md:divide-x divide-slate-200">
                    <div class="flex flex-col items-center px-2 pt-2 md:pt-0">
                        <span id="totalJobs" class="text-2xl font-semibold text-slate-900 leading-none mb-1">0</span>
                        <span class="text-xs font-medium tracking-wide text-slate-500 uppercase">Workers</span>
                    </div>
                    <div class="flex flex-col items-center px-2 pt-2 md:pt-0">
                        <span id="queuedJobs" class="text-2xl font-semibold text-slate-900 leading-none mb-1">0</span>
                        <span class="text-xs font-medium tracking-wide text-slate-500 uppercase">Queued</span>
                    </div>
                    <div class="flex flex-col items-center px-2 pt-2 md:pt-0">
                        <span id="processingJobs" class="text-2xl font-semibold text-slate-900 leading-none mb-1">0</span>
                        <span class="text-xs font-medium tracking-wide text-slate-500 uppercase">Processing</span>
                    </div>
                    <div class="flex flex-col items-center px-2 pt-2 md:pt-0">
                        <span id="completedJobs" class="text-2xl font-semibold text-[#F36C21] leading-none mb-1">0</span>
                        <span class="text-xs font-medium tracking-wide text-slate-500 uppercase">Completed</span>
                    </div>
                </div>
            </div>

            <!-- Upload Area -->
            <div id="uploadArea" class="relative group cursor-pointer">
                <!-- Login Overlay -->
                <div id="loginOverlay" style="display: none;" class="absolute inset-0 bg-white/95 rounded-xl flex flex-col items-center justify-center z-10 cursor-pointer">
                    <i data-lucide="lock" class="w-10 h-10 text-[#F36C21] mb-3"></i>
                    <h3 class="text-lg font-semibold text-slate-900 mb-1">Log in first</h3>
                    <p class="text-sm text-slate-500">Please log in with your Google account to use the converter</p>
                </div>

                <!-- Access Denied Overlay -->
                <div id="accessDeniedOverlay" style="display: none;" class="absolute inset-0 bg-white/98 rounded-xl flex flex-col items-center justify-center z-10 p-6 text-center">
                    <i data-lucide="shield-x" class="w-10 h-10 text-rose-500 mb-3"></i>
                    <h3 class="text-lg font-semibold text-slate-900 mb-1">Access Required</h3>
                    <p id="accessDeniedMessage" class="text-sm text-slate-500 mb-4">Your account is not approved to use the converter.</p>
                    <button id="requestAccessBtn" onclick="requestAccess()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors duration-200">
                        Request Access
                    </button>
                    <div id="requestStatus" style="display: none;" class="mt-3 px-4 py-2 rounded-lg text-sm"></div>
                </div>

                <!-- Default Upload State -->
                <div id="uploadDefault" class="border-2 border-dashed border-slate-200 rounded-xl p-10 flex flex-col items-center justify-center text-center transition-all duration-300 hover:border-[#F36C21] hover:bg-slate-50/50">
                    <div class="w-14 h-14 bg-slate-100 text-slate-400 rounded-xl flex items-center justify-center mb-4">
                        <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                    </div>
                    <h3 class="text-lg font-medium text-slate-900 mb-1">Drop your JPK file here or click to browse</h3>
                    <p class="text-base text-slate-500 max-w-sm mx-auto">
                        Supports JPK files up to 100MB <span class="text-slate-300 mx-1">&bull;</span> Asynchronous processing
                    </p>
                </div>

                <!-- Success State (file selected) -->
                <div id="uploadSuccess" style="display: none;" class="relative">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-green-400 to-emerald-500 rounded-2xl opacity-10"></div>
                    <div class="relative bg-white border-2 border-dashed border-emerald-200 rounded-xl p-10 flex flex-col items-center justify-center text-center">
                        <div class="w-14 h-14 bg-emerald-100 text-emerald-600 rounded-xl flex items-center justify-center mb-4 shadow-sm">
                            <i data-lucide="check" class="w-8 h-8 stroke-[3]"></i>
                        </div>
                        <h3 class="text-lg font-medium text-slate-900 mb-1">File selected successfully!</h3>
                        <p class="text-base text-slate-500 max-w-sm mx-auto">
                            Supports JPK files up to 100MB <span class="text-slate-300 mx-1">&bull;</span> Asynchronous processing
                        </p>
                    </div>
                </div>

                <input type="file" id="fileInput" accept=".jpk" class="hidden">
            </div>

            <!-- Selected File Details -->
            <div id="fileInfo" style="display: none;" class="bg-slate-50 border border-slate-100 rounded-xl p-5 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div>
                    <h4 class="text-sm font-semibold text-slate-900 mb-1">Selected File</h4>
                    <div class="flex flex-col gap-1">
                        <span id="fileName" class="text-base text-slate-600 font-mono text-sm bg-white border border-slate-200 px-2 py-0.5 rounded w-fit"></span>
                        <span id="fileSize" class="text-sm text-slate-400"></span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="resetForm()" class="text-sm font-medium text-slate-500 hover:text-slate-800 transition-colors">Replace</button>
                </div>
            </div>

            <!-- JPK Analysis -->
            <div id="jpkAnalysis" style="display: none;" class="bg-slate-50/50 border border-slate-200 rounded-xl p-6">
                <div class="flex items-center gap-2 mb-6">
                    <i data-lucide="bar-chart-3" class="w-5 h-5 text-[#F36C21]"></i>
                    <h3 class="text-lg font-semibold text-slate-900 tracking-tight">JPK Analysis</h3>
                </div>
                <div id="analysisContent">
                    <div class="text-center py-4 text-slate-500">
                        <div class="inline-block w-5 h-5 border-2 border-slate-300 border-t-[#F36C21] rounded-full animate-spin mr-2"></div>
                        Analyzing JPK file...
                    </div>
                </div>
            </div>

            <!-- Progress Container -->
            <div id="progressContainer" style="display: none;" class="space-y-3">
                <p id="progressText" class="text-sm text-slate-600 text-center">Preparing conversion...</p>
                <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                    <div id="progressFill" class="h-full bg-gradient-to-r from-[#F36C21] to-orange-400 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Status Message -->
            <div id="statusMessage"></div>

            <!-- Convert Button -->
            <button id="convertBtn" onclick="startConversion()" disabled class="w-full bg-[#F36C21] hover:bg-[#e05a10] disabled:bg-slate-200 disabled:text-slate-400 text-white py-3 rounded-xl text-base font-semibold transition-colors duration-200">
                Convert to JSON
            </button>

            <!-- Download Section -->
            <div id="downloadSection" style="display: none;" class="flex flex-col sm:flex-row gap-3">
                <button id="downloadBtn" onclick="downloadFile()" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-xl text-base font-semibold transition-colors duration-200 flex items-center justify-center gap-2">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    Download JSON File
                </button>
                <button onclick="resetForm()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-xl text-base font-semibold transition-colors duration-200">
                    Convert Another File
                </button>
            </div>

            <!-- Batch Processing Section -->
            <div class="border-t border-slate-200 pt-6 mt-6">
                <h3 class="text-lg font-semibold text-slate-900 mb-2">Batch Processing</h3>
                <p class="text-sm text-slate-500 mb-4">Upload multiple JPK files for concurrent processing</p>
                <input type="file" id="batchInput" multiple accept=".jpk" class="hidden">
                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="batchSelectBtn" onclick="document.getElementById('batchInput').click()" class="flex-1 bg-orange-100 hover:bg-orange-200 text-[#F36C21] py-3 rounded-xl text-sm font-semibold transition-colors duration-200">
                        Select Multiple Files
                    </button>
                    <button id="batchConvertBtn" onclick="startBatchConversion()" disabled class="flex-1 bg-[#F36C21] hover:bg-[#e05a10] disabled:bg-slate-200 disabled:text-slate-400 text-white py-3 rounded-xl text-sm font-semibold transition-colors duration-200">
                        Process Batch
                    </button>
                </div>

                <!-- Batch Jobs List -->
                <div id="batchJobs" style="display: none;" class="mt-4 space-y-2">
                    <h4 class="text-sm font-semibold text-slate-700">Batch Jobs</h4>
                    <div id="batchJobsList" class="space-y-2"></div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Authentication state
        let currentUser = null;
        let isAuthenticated = false;
        let isApproved = false;
        let isAdmin = false;
        let requestStatus = null;

        // Job tracking
        let currentJobId = null;
        let selectedFile = null;
        let selectedBatchFiles = [];
        let batchJobIds = [];
        let statusCheckInterval = null;
        let queueStatusInterval = null;

        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const batchInput = document.getElementById('batchInput');

        // Check authentication status on page load
        async function checkAuthStatus() {
            try {
                const response = await fetch('/auth/status');
                const data = await response.json();

                isAuthenticated = data.authenticated;
                isApproved = data.approved;
                isAdmin = data.is_admin;
                currentUser = data.user;
                requestStatus = data.request_status || null;

                updateAuthUI();
            } catch (error) {
                console.error('Error checking auth status:', error);
                updateAuthUI();
            }
        }

        // Update authentication UI
        function updateAuthUI() {
            const loginSection = document.getElementById('loginSection');
            const userSection = document.getElementById('userSection');
            const userName = document.getElementById('userName');
            const userInitials = document.getElementById('userInitials');
            const loginOverlay = document.getElementById('loginOverlay');
            const accessDeniedOverlay = document.getElementById('accessDeniedOverlay');
            const accessDeniedMessage = document.getElementById('accessDeniedMessage');
            const requestAccessBtn = document.getElementById('requestAccessBtn');
            const requestStatusDiv = document.getElementById('requestStatus');
            const adminLink = document.getElementById('adminLink');
            const convertBtn = document.getElementById('convertBtn');
            const batchSelectBtn = document.getElementById('batchSelectBtn');
            const batchConvertBtn = document.getElementById('batchConvertBtn');

            // Hide all overlays by default
            loginOverlay.style.display = 'none';
            accessDeniedOverlay.style.display = 'none';

            if (isAuthenticated && currentUser) {
                // Show user info
                loginSection.style.display = 'none';
                userSection.style.display = 'flex';
                userName.textContent = currentUser.name || currentUser.email;

                // Generate initials
                const name = currentUser.name || currentUser.email || '';
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                userInitials.textContent = initials;

                // Show admin link if user is admin
                adminLink.style.display = isAdmin ? 'inline-flex' : 'none';

                if (isApproved) {
                    // User is authenticated AND approved
                    uploadArea.classList.remove('pointer-events-none', 'opacity-50');
                } else {
                    // User is authenticated but NOT approved
                    uploadArea.classList.add('pointer-events-none', 'opacity-50');
                    accessDeniedOverlay.style.display = 'flex';

                    if (requestStatus === 'pending') {
                        accessDeniedMessage.textContent = 'Your access request is pending approval.';
                        requestAccessBtn.style.display = 'none';
                        requestStatusDiv.style.display = 'block';
                        requestStatusDiv.className = 'mt-3 px-4 py-2 rounded-lg text-sm bg-amber-100 text-amber-700';
                        requestStatusDiv.textContent = 'Pending - An admin will review your request';
                    } else if (requestStatus === 'denied') {
                        accessDeniedMessage.textContent = 'Your access request was denied.';
                        requestAccessBtn.style.display = 'none';
                        requestStatusDiv.style.display = 'block';
                        requestStatusDiv.className = 'mt-3 px-4 py-2 rounded-lg text-sm bg-rose-100 text-rose-700';
                        requestStatusDiv.textContent = 'Denied - Contact an administrator';
                    } else {
                        accessDeniedMessage.textContent = 'Your account is not approved to use the converter.';
                        requestAccessBtn.style.display = 'inline-block';
                        requestStatusDiv.style.display = 'none';
                    }
                }
            } else {
                // Not authenticated
                loginSection.style.display = 'block';
                userSection.style.display = 'none';
                uploadArea.classList.add('pointer-events-none', 'opacity-50');
                loginOverlay.style.display = 'flex';
            }

            lucide.createIcons();
        }

        // Request access function
        async function requestAccess() {
            const btn = document.getElementById('requestAccessBtn');
            const statusDiv = document.getElementById('requestStatus');

            btn.disabled = true;
            btn.textContent = 'Requesting...';

            try {
                const response = await fetch('/api/request-access', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: 'Requesting access to JPK to JSON converter' })
                });

                const data = await response.json();

                if (response.ok) {
                    requestStatus = 'pending';
                    btn.style.display = 'none';
                    statusDiv.style.display = 'block';
                    statusDiv.className = 'mt-3 px-4 py-2 rounded-lg text-sm bg-amber-100 text-amber-700';
                    statusDiv.textContent = 'Request submitted! An admin will review your request.';
                    document.getElementById('accessDeniedMessage').textContent = 'Your access request is pending approval.';
                } else {
                    statusDiv.style.display = 'block';
                    statusDiv.className = 'mt-3 px-4 py-2 rounded-lg text-sm bg-rose-100 text-rose-700';
                    statusDiv.textContent = data.error || 'Failed to submit request';
                    btn.disabled = false;
                    btn.textContent = 'Request Access';
                }
            } catch (error) {
                statusDiv.style.display = 'block';
                statusDiv.className = 'mt-3 px-4 py-2 rounded-lg text-sm bg-rose-100 text-rose-700';
                statusDiv.textContent = 'Error: ' + error.message;
                btn.disabled = false;
                btn.textContent = 'Request Access';
            }
        }

        // File upload handling
        uploadArea.addEventListener('click', (e) => {
            if (e.target.closest('#loginOverlay')) {
                window.location.href = '/login';
                return;
            }
            if (!e.target.closest('#accessDeniedOverlay')) {
                fileInput.click();
            }
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.querySelector('#uploadDefault')?.classList.add('border-[#F36C21]', 'bg-orange-50');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.querySelector('#uploadDefault')?.classList.remove('border-[#F36C21]', 'bg-orange-50');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.querySelector('#uploadDefault')?.classList.remove('border-[#F36C21]', 'bg-orange-50');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                if (files.length === 1) {
                    handleFile(files[0]);
                } else {
                    handleBatchFiles(Array.from(files));
                }
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        });

        batchInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleBatchFiles(Array.from(e.target.files));
        });

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.jpk')) {
                showStatus('Only JPK files are allowed', 'error');
                return;
            }

            if (file.size > 100 * 1024 * 1024) {
                showStatus('File size must be less than 100MB', 'error');
                return;
            }

            selectedFile = file;

            // Update UI
            document.getElementById('uploadDefault').style.display = 'none';
            document.getElementById('uploadSuccess').style.display = 'block';
            document.getElementById('fileInfo').style.display = 'flex';
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = 'Size: ' + formatFileSize(file.size);
            document.getElementById('convertBtn').disabled = false;

            // Analyze the JPK file
            analyzeFile(file);

            lucide.createIcons();
        }

        async function analyzeFile(file) {
            const jpkAnalysis = document.getElementById('jpkAnalysis');
            const analysisContent = document.getElementById('analysisContent');

            jpkAnalysis.style.display = 'block';
            analysisContent.innerHTML = '<div class="text-center py-4 text-slate-500"><div class="inline-block w-5 h-5 border-2 border-slate-300 border-t-[#F36C21] rounded-full animate-spin mr-2"></div>Analyzing JPK file...</div>';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/converter/analyze', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Analysis failed');
                }

                const analysis = await response.json();
                displayAnalysis(analysis);

            } catch (error) {
                analysisContent.innerHTML = `<div class="text-center py-4 text-rose-500">Analysis failed: ${error.message}</div>`;
            }
        }

        function displayAnalysis(analysis) {
            const analysisContent = document.getElementById('analysisContent');
            const counts = analysis.counts;
            const totalComponents = Object.values(counts).reduce((a, b) => a + b, 0);

            let html = '';

            // Project name
            if (analysis.project_name) {
                html += `<div class="text-[#F36C21] font-semibold mb-4 p-3 bg-white rounded-lg border-l-4 border-[#F36C21]">Project: ${analysis.project_name}</div>`;
            }

            // Component counts grid
            html += '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3 mb-6">';
            html += `<div class="bg-white p-3 rounded-lg shadow-sm border border-slate-100 flex flex-col items-center justify-center min-h-[5rem]">
                <span class="text-2xl font-semibold text-slate-900 mb-1">${counts.operations}</span>
                <span class="text-[0.65rem] font-bold tracking-wider text-slate-400 uppercase">Operations</span>
            </div>`;
            html += `<div class="bg-white p-3 rounded-lg shadow-sm border border-slate-100 flex flex-col items-center justify-center min-h-[5rem]">
                <span class="text-2xl font-semibold text-slate-900 mb-1">${counts.transformations}</span>
                <span class="text-[0.65rem] font-bold tracking-wider text-slate-400 uppercase">Transforms</span>
            </div>`;
            html += `<div class="bg-white p-3 rounded-lg shadow-sm border border-slate-100 flex flex-col items-center justify-center min-h-[5rem]">
                <span class="text-2xl font-semibold text-slate-900 mb-1">${counts.scripts}</span>
                <span class="text-[0.65rem] font-bold tracking-wider text-slate-400 uppercase">Scripts</span>
            </div>`;
            html += `<div class="bg-white p-3 rounded-lg shadow-sm border border-slate-100 flex flex-col items-center justify-center min-h-[5rem]">
                <span class="text-2xl font-semibold text-slate-900 mb-1">${counts.endpoints}</span>
                <span class="text-[0.65rem] font-bold tracking-wider text-slate-400 uppercase">Endpoints</span>
            </div>`;
            html += `<div class="bg-white p-3 rounded-lg shadow-sm border border-slate-100 flex flex-col items-center justify-center min-h-[5rem]">
                <span class="text-2xl font-semibold text-slate-900 mb-1">${counts.project_variables + counts.global_variables}</span>
                <span class="text-[0.65rem] font-bold tracking-wider text-slate-400 uppercase">Variables</span>
            </div>`;
            html += `<div class="bg-white p-3 rounded-lg shadow-sm border border-slate-100 flex flex-col items-center justify-center min-h-[5rem] border-t-2 border-t-[#F36C21]">
                <span class="text-2xl font-semibold text-slate-900 mb-1">${totalComponents}</span>
                <span class="text-[0.65rem] font-bold tracking-wider text-slate-400 uppercase">Total</span>
            </div>`;
            html += '</div>';

            // Operations list
            if (analysis.operations && analysis.operations.length > 0) {
                html += '<div class="mb-4">';
                html += '<h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Operations</h4>';
                html += '<div class="flex flex-wrap gap-2">';
                analysis.operations.forEach(op => {
                    html += `<span class="bg-white text-slate-600 px-3 py-1 rounded-full text-sm border border-slate-200">${op.name}</span>`;
                });
                html += '</div></div>';
            }

            // Transformations list
            if (analysis.transformations && analysis.transformations.length > 0) {
                html += '<div>';
                html += '<h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Transformations</h4>';
                html += '<div class="flex flex-wrap gap-2">';
                analysis.transformations.forEach(tf => {
                    html += `<span class="bg-white text-slate-600 px-3 py-1 rounded-full text-sm border border-slate-200">${tf.name}</span>`;
                });
                html += '</div></div>';
            }

            analysisContent.innerHTML = html;
        }

        function handleBatchFiles(files) {
            const validFiles = files.filter(file => {
                if (!file.name.toLowerCase().endsWith('.jpk')) {
                    showStatus(`Skipping ${file.name}: Only JPK files are allowed`, 'error');
                    return false;
                }
                if (file.size > 100 * 1024 * 1024) {
                    showStatus(`Skipping ${file.name}: File too large`, 'error');
                    return false;
                }
                return true;
            });

            if (validFiles.length === 0) return;

            selectedBatchFiles = validFiles;
            document.getElementById('batchConvertBtn').disabled = false;
            showStatus(`${validFiles.length} files selected for batch processing`, 'info');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function startConversion() {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                document.getElementById('convertBtn').disabled = true;
                document.getElementById('progressContainer').style.display = 'block';

                const response = await fetch('/api/converter/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.status === 401) {
                    showStatus('Please log in to use the converter', 'error');
                    if (result.redirect) window.location.href = result.redirect;
                    return;
                }

                if (response.status === 403) {
                    showStatus(result.message || 'Access denied. Please request access.', 'error');
                    isApproved = false;
                    updateAuthUI();
                    return;
                }

                if (!response.ok) {
                    throw new Error(result.error || 'Upload failed');
                }

                currentJobId = result.job_id;
                showStatus(result.message, 'info');
                statusCheckInterval = setInterval(checkStatus, 1000);

            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                resetProgress();
            }
        }

        async function startBatchConversion() {
            if (selectedBatchFiles.length === 0) return;

            const formData = new FormData();
            selectedBatchFiles.forEach(file => formData.append('files', file));

            try {
                document.getElementById('batchConvertBtn').disabled = true;
                showStatus('Starting batch conversion...', 'info');

                const response = await fetch('/api/converter/batch/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.status === 401) {
                    showStatus('Please log in to use the converter', 'error');
                    if (result.redirect) window.location.href = result.redirect;
                    return;
                }

                if (!response.ok) {
                    throw new Error(result.error || 'Batch upload failed');
                }

                batchJobIds = result.job_ids;
                showStatus(result.message, 'success');
                displayBatchJobs(result.results);
                startBatchMonitoring();

            } catch (error) {
                showStatus(`Batch Error: ${error.message}`, 'error');
                document.getElementById('batchConvertBtn').disabled = false;
            }
        }

        function displayBatchJobs(jobs) {
            const batchJobs = document.getElementById('batchJobs');
            const batchJobsList = document.getElementById('batchJobsList');
            batchJobs.style.display = 'block';
            batchJobsList.innerHTML = '';

            jobs.forEach(job => {
                const statusColors = {
                    queued: 'bg-amber-100 text-amber-700',
                    processing: 'bg-blue-100 text-blue-700',
                    completed: 'bg-emerald-100 text-emerald-700',
                    error: 'bg-rose-100 text-rose-700'
                };
                const jobElement = document.createElement('div');
                jobElement.className = 'bg-slate-50 rounded-lg p-3 flex justify-between items-center';
                jobElement.innerHTML = `
                    <div>
                        <div class="font-medium text-slate-900 text-sm">${job.filename}</div>
                        <div class="text-xs text-slate-400">${job.job_id}</div>
                    </div>
                    <span id="status-${job.job_id}" class="px-3 py-1 rounded-full text-xs font-semibold uppercase ${statusColors[job.status] || statusColors.queued}">${job.status}</span>
                `;
                batchJobsList.appendChild(jobElement);
            });
        }

        function startBatchMonitoring() {
            const batchInterval = setInterval(async () => {
                let allCompleted = true;

                for (const jobId of batchJobIds) {
                    try {
                        const response = await fetch(`/api/converter/status/${jobId}`);
                        const status = await response.json();

                        const statusElement = document.getElementById(`status-${jobId}`);
                        if (statusElement) {
                            const statusColors = {
                                queued: 'bg-amber-100 text-amber-700',
                                processing: 'bg-blue-100 text-blue-700',
                                completed: 'bg-emerald-100 text-emerald-700',
                                error: 'bg-rose-100 text-rose-700'
                            };
                            statusElement.textContent = status.status;
                            statusElement.className = `px-3 py-1 rounded-full text-xs font-semibold uppercase ${statusColors[status.status] || statusColors.queued}`;
                        }

                        if (status.status !== 'completed' && status.status !== 'error') {
                            allCompleted = false;
                        }
                    } catch (error) {
                        console.error(`Error checking status for ${jobId}:`, error);
                    }
                }

                if (allCompleted) {
                    clearInterval(batchInterval);
                    showStatus('Batch processing completed!', 'success');
                    document.getElementById('batchConvertBtn').disabled = false;
                }
            }, 2000);
        }

        async function checkStatus() {
            if (!currentJobId) return;

            try {
                const response = await fetch(`/api/converter/status/${currentJobId}`);
                const status = await response.json();

                if (response.status === 401) {
                    clearInterval(statusCheckInterval);
                    showStatus('Session expired. Please log in again.', 'error');
                    if (status.redirect) setTimeout(() => window.location.href = status.redirect, 2000);
                    return;
                }

                if (!response.ok) {
                    throw new Error(status.error || 'Status check failed');
                }

                updateProgress(status.progress || 0, status.message || 'Processing...');

                if (status.status === 'completed') {
                    clearInterval(statusCheckInterval);
                    showStatus(status.message, 'success');
                    document.getElementById('downloadSection').style.display = 'flex';
                    document.getElementById('convertBtn').style.display = 'none';
                    resetProgress();
                } else if (status.status === 'error') {
                    clearInterval(statusCheckInterval);
                    showStatus(status.message, 'error');
                    resetProgress();
                }

            } catch (error) {
                clearInterval(statusCheckInterval);
                showStatus(`Error checking status: ${error.message}`, 'error');
                resetProgress();
            }
        }

        function startQueueMonitoring() {
            queueStatusInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/converter/queue/status');
                    const stats = await response.json();

                    document.getElementById('totalJobs').textContent = stats.total_jobs;
                    document.getElementById('queuedJobs').textContent = stats.queued;
                    document.getElementById('processingJobs').textContent = stats.processing;
                    document.getElementById('completedJobs').textContent = stats.completed;

                } catch (error) {
                    console.error('Error fetching queue status:', error);
                }
            }, 3000);
        }

        function updateProgress(percent, message) {
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = message;
        }

        function resetProgress() {
            document.getElementById('convertBtn').disabled = false;
            document.getElementById('progressContainer').style.display = 'none';
            updateProgress(0, 'Preparing conversion...');
        }

        function showStatus(message, type) {
            const colors = {
                success: 'bg-emerald-50 text-emerald-700 border-emerald-200',
                error: 'bg-rose-50 text-rose-700 border-rose-200',
                info: 'bg-blue-50 text-blue-700 border-blue-200'
            };
            document.getElementById('statusMessage').innerHTML = `<div class="p-4 rounded-xl border ${colors[type] || colors.info} text-sm">${message}</div>`;
            if (type !== 'success') {
                setTimeout(() => document.getElementById('statusMessage').innerHTML = '', 5000);
            }
        }

        async function downloadFile() {
            if (!currentJobId) return;

            try {
                const response = await fetch(`/api/converter/download/${currentJobId}`);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Download failed');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = selectedFile.name.replace('.jpk', '.json');
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showStatus('File downloaded successfully!', 'success');

            } catch (error) {
                showStatus(`Download error: ${error.message}`, 'error');
            }
        }

        function resetForm() {
            if (currentJobId) {
                fetch(`/api/converter/cleanup/${currentJobId}`, { method: 'DELETE' });
                currentJobId = null;
            }

            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }

            selectedFile = null;
            selectedBatchFiles = [];
            batchJobIds = [];
            fileInput.value = '';
            batchInput.value = '';

            document.getElementById('uploadDefault').style.display = 'flex';
            document.getElementById('uploadSuccess').style.display = 'none';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('jpkAnalysis').style.display = 'none';
            document.getElementById('downloadSection').style.display = 'none';
            document.getElementById('batchJobs').style.display = 'none';
            document.getElementById('statusMessage').innerHTML = '';
            document.getElementById('convertBtn').disabled = true;
            document.getElementById('convertBtn').style.display = 'block';
            document.getElementById('batchConvertBtn').disabled = true;
            resetProgress();

            lucide.createIcons();
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (currentJobId) {
                navigator.sendBeacon(`/api/converter/cleanup/${currentJobId}`, JSON.stringify({}));
            }
            if (queueStatusInterval) clearInterval(queueStatusInterval);
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
            startQueueMonitoring();
        });
    </script>
</body>
</html>
